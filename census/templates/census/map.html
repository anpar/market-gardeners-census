{% extends "census/base.html" %}

{% load static %}

{% block additional_css %}
	<!--<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
	      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
	      crossorigin=""/>-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
	      integrity="sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKESxces60Mpoj+2okopSAcSUIUOseddDm0cxnGQzxIR7vJgsLZbdLE3w=="
	      crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="{% static 'census/css/leaflet.legend.css' %}" />
{% endblock additional_css %}

{% block title %}
	Carte des fermes maraîchères diversifiées en Wallonie et à Bruxelles
{% endblock title %}

{% block content %}
	<div class="container mt-4">
		<h1>Carte des fermes maraîchères diversifiées</h1>

		<p class="alert alert-warning" role="alert">
			Vous n'êtes <b>pas</b> sur la carte ?
			<a class="btn btn-sm btn-success" href="{% url 'census:create' %}">Ajouter votre ferme</a>
		</p>

		<p>La carte ci-dessous liste, par commune, l'ensemble des fermes maraîchères diversifiées recensées sur la plateforme.</p>

		<p>
			Les communes en <span style="color: #0101fe;"><b>bleu</b></span> comptent au moins un·e maraîcher·ère. La surface du cercle
			est proportionnelle au nombre de maraîcher·ères recensé·es dans la commune. Les communes en
			<span style="color: #565e64;"><b>gris</b></span> ne comptent pour le moment aucun·e maraîcher·ère recensé·e.
		</p>

		<hr class="my-4">

		<div class="text-center mt-4 mb-4">
			<!-- The data-filter attribute corresponds to the className of the circles on the Map -->
			<button type="button" class="btn btn-primary mt-1" onClick="filterProvince(this)" data-filter=".brabant-wallon">Brabant wallon</button>
			<button type="button" class="btn btn-primary mt-1" onClick="filterProvince(this)" data-filter=".hainaut">Hainaut</button>
			<button type="button" class="btn btn-primary mt-1" onClick="filterProvince(this)" data-filter=".namur">Namur</button>
			<button type="button" class="btn btn-primary mt-1" onClick="filterProvince(this)" data-filter=".liège">Liège</button>
			<button type="button" class="btn btn-primary mt-1" onClick="filterProvince(this)" data-filter=".luxembourg">Luxembourg</button>
			<button type="button" class="btn btn-primary mt-1" onClick="filterProvince(this)" data-filter=".bruxelles">Bruxelles</button>
			<button type="button" class="btn btn-primary mt-1" onClick="filterProvince(this)" data-filter=".brabant-flamand">Brabant flamand</button>
			<button type="button" class="btn btn-secondary active mt-1" onClick="filterProvince(this)" data-filter="all">Tout afficher</button>
		</div>

	  <div id="map"></div>
	</div>
{% endblock content %}

{% block script %}
	<!--<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
	        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
	        crossorigin=""></script>-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"
	        integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg=="
	        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script type="text/javascript" src="{% static 'census/js/leaflet.legend.js' %}"></script>

	<script>
		const map = L.map('map').setView([50.220, 4.911], 8);

		L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
	    maxZoom: 19,
	    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
		}).addTo(map);

		let coord, circle;

		{% for m in municipalities %}
			coord = '{{ m.GPS_coordinates }}'.split(", ")

			{% if m.farm_set.values %}
				circle = L.circle([coord[0], coord[1]], {
					color: 'blue',
					opacity: 1.0,
					fillColor: 'blue',
					fillOpacity: 0.65,
					radius: 1000 * Math.sqrt({{ m.farm_set.values|length }}),
					// The className allows filtering by province
					className: '{{ m.province }}'.replace(/\s+/g, '-').toLowerCase()
				}).addTo(map);

				circle.bindPopup("<b>{{ m.name }}</b> :"
												+"<ul>{% for f in m.farm_set.values %}{% if f.public %}<li>"
												+"<a href={% url 'census:view' f.id %}>"
												+'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/></svg>'
												+"</a>&nbsp;{{ f.name }}"
												+ '{% if f.edited_by_user %}&nbsp;<img alt="Green check" title="Ferme validée et mise à jour par le/la maraîcher·ère" src="{% static 'census/icon-yes.svg' %}"/>{% endif %}'
												+ '{% if f.fb_page %}&nbsp;<a class="link-underline link-underline-opacity-0"href="{{ f.fb_page }}"target=_blank><svg class="bi bi-facebook"fill=currentColor height=14 viewBox="0 0 16 16"width=14 xmlns=http://www.w3.org/2000/svg><path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951"/></svg></a>{% endif %}{% if f.website %}&nbsp;<a class="link-underline link-underline-opacity-0"href="{{ f.website }}"target=_blank><svg class="bi bi-link-45deg"fill=currentColor height=16 viewBox="0 0 16 16"width=16 xmlns=http://www.w3.org/2000/svg><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1 1 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4 4 0 0 1-.128-1.287z"/><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243z"/></svg></a>{% endif %}'
												+"</li>{% endif %}{% endfor %}</ul>")
			{% else %}
				circle = L.circle([coord[0], coord[1]], {
					color: 'gray',
					opacity: 1.0,
					fillColor: 'gray',
					fillOpacity: 0.75,
					radius: 1000,
					// The className allows filtering by province
					className: '{{ m.province }}'.replace(/\s+/g, '-').toLowerCase()
				}).addTo(map);
				circle.bindPopup('<p><b>{{ m.name }}</b> : pas de ferme maraîchère diversifiée recensée dans cette commune.</p>'
												+'<p class="text-center"><a class="btn btn-sm btn-success text-light" href="{% url 'census:create' %}">Ajouter votre ferme</a> '
												+'ou <a href="/#contact">contactez-nous</a> !</p>')
			{% endif %}
		{% endfor %}

		L.control.Legend({
      position: "bottomleft",
      legends: [{
        label: "Commune sans maraîcher·ère recensé·e",
        type: "circle",
				color: 'gray',
				opacity: 1.0,
				fillColor: 'gray',
				fillOpacity: 0.75,
				radius: 500,
      }, {
				label: "Commune avec au moins un·e maraîcher·ère recensé·e",
	      type: "circle",
	      color: 'blue',
				opacity: 1.0,
				fillColor: 'blue',
				fillOpacity: 0.65,
	      radius: 500,
      }]
		}).addTo(map);

		function filterProvince(btn) {
			const data_filter = btn.getAttribute('data-filter');

			if (data_filter === 'all') {
				[].forEach.call(document.getElementsByClassName('leaflet-interactive'), function (el) {
					el.style.visibility = 'visible';
				});

				map.setView([50.220, 4.911], 8);
			} else {
				[].forEach.call(document.getElementsByClassName('leaflet-interactive'), function (el) {
					el.style.visibility = 'visible';
				});

				[].forEach.call(document.querySelectorAll('path.leaflet-interactive:not(' + data_filter + ')'), function (el) {
					el.style.visibility = 'hidden';
				});
			}

			if (data_filter === '.brabant-wallon') {
				map.setView([50.660, 4.564], 10)
			} else if (data_filter === '.hainaut') {
				map.setView([50.402, 3.801], 9)
			} else if (data_filter === '.namur') {
				map.setView([50.200, 4.812], 9)
			} else if (data_filter === '.luxembourg') {
				map.setView([49.946, 5.422], 9)
			} else if (data_filter === '.liège') {
				map.setView([50.498, 5.707], 9)
			} else if (data_filter === '.bruxelles') {
				map.setView([50.822, 4.377], 11)
			} else if (data_filter === '.brabant-flamand') {
				// TODO: à recentrer si d'autres communes du brabant flamand s'ajoutent
				map.setView([50.822, 4.377], 11)
			}

			let buttons = document.getElementsByTagName('button')
			for (var i = 0; i < buttons.length; i++) {
				buttons[i].classList.remove('active')
			}

			btn.classList.add('active')
	}
	</script>

{% endblock %}